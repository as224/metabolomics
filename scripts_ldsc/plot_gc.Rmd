---
title: "plot_gc"
author: "AÃ¯sha Schuhegger"
date: "2/15/2024"
output: html_document
---

# This script is for plotting the genetic correlations as bar plots, heatmaps and pheatmaps. 
# Load libraries
```{r}
library(ggplot2)
library(reshape2)
```

# Read in the separate tsv files (output_ld_regression tsv files)
```{r}
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
folder_path <- "../output_ld_regression"
folder_path_plots <- "../plots/"
folder_barplots <- "../plots/barplots"
folder_heatmaps <- "../plots/heatmaps"

# Check if the folder exists
if (!dir.exists(folder_path_plots)) {
  # If the folder does not exist, create it
  dir.create(folder_path_plots, recursive = TRUE)
  print(paste("Folder", folder_path_plots, "created."))
} else {
  print(paste("Folder", folder_path_plots, "already exists."))
}

if (!dir.exists(folder_barplots)) {
  # If the folder does not exist, create it
  dir.create(folder_barplots, recursive = TRUE)
  print(paste("Folder", folder_barplots, "created."))
} else {
  print(paste("Folder", folder_barplots, "already exists."))
}

if (!dir.exists(folder_heatmaps)) {
  # If the folder does not exist, create it
  dir.create(folder_heatmaps, recursive = TRUE)
  print(paste("Folder", folder_heatmaps, "created."))
} else {
  print(paste("Folder", folder_heatmaps, "already exists."))
}


files <- list.files(path = folder_path, pattern = "^output_.*\\.tsv$", full.names = TRUE)
#files_capped <- list.files(path = folder_path, pattern = "^capped_.*\\.tsv$", full.names = TRUE) #not necessary 

df <- read.table(paste(folder_path,"/complete_df.tsv", sep=""), header=TRUE)
df_adjusted <- read.table(paste(folder_path,"/complete_df_adjusted.tsv", sep=""), header=TRUE)

matrix <- read.table(paste(folder_path, "/matrix_df.tsv", sep=""), header=TRUE)
matrix_woCorrection <- read.table(paste(folder_path, "/matrix_df_woCorrection.tsv", sep=""), header=TRUE)
```


# Create barplots (and boxplots) for each p1_id 
```{r}
for (file in files) {
  data <- read.table(file, header = TRUE, sep = "\t")
  unique_p1_id <- unique(data$p1_id)
  
  barplot_gc <- ggplot(data, aes(x = id, y = rg, fill = method)) +
                  geom_bar(stat = "identity", position = "dodge") +
                  geom_errorbar(aes(ymin = rg - se, ymax = rg + se), width = 0.2, position = position_dodge(0.9)) + # Add error bars
                  scale_fill_manual(values = c("ldsc" = "coral")) +
                  labs(x = "", y = "Genetic Correlation", title = paste("Genetic Correlation of", unique_p1_id, "(LDSC)")) +
                  theme(axis.text.x = element_text(angle = 90, hjust = 0.5, vjust = 0.5, size = 8)) +
                  theme(legend.position = c(0.9, 0.99),
                        legend.text = element_text(size = 8)) + # Adjust legend text size
                  guides(fill = guide_legend(title = "Method", override.aes = list(fill = c("coral"))))

  # Save barplot
  ggsave(file = paste(folder_barplots, "/barplot_", unique_p1_id, ".png", sep = ""), plot = barplot_gc, width = 8, height = 6, units = "in", dpi = 300)
}
```

```{r}
# Capping values (>1 -> 1 and <-1 -> -1) --> Since meeting (19.02.) gc >1 -> 0 and gc<-1 -> 0, thus no capping is necessary anymore 

# for (file in files_capped) {
#   data_capped <- read.table(file, header = TRUE, sep = "\t")
#   unique_p1_id <- unique(data_capped$p1_id)
#   
#   barplot_gc_capped <- ggplot(data_capped, aes(x = id, y = rg, fill = method)) +
#                   geom_bar(stat = "identity", position = "dodge") +
#                   geom_errorbar(aes(ymin = rg - se, ymax = rg + se), width = 0.2, position = position_dodge(0.9)) + # Add error bars
#                   scale_fill_manual(values = c("ldsc" = "coral")) +
#                   labs(x = "", y = "Genetic Correlation", title = paste("Genetic Correlation of", unique_p1_id, "(capped values, LDSC)")) +
#                   theme(axis.text.x = element_text(angle = 90, hjust = 0.5, vjust = 0.5, size = 8)) +
#                   theme(legend.position = c(0.9, 0.99),
#                         legend.text = element_text(size = 8)) + # Adjust legend text size
#                   guides(fill = guide_legend(title = "Method", override.aes = list(fill = c("coral"))))
# 
#   # Save barplot
#   ggsave(file = paste("../plots/barplots/barplot_", unique_p1_id, "_capped.png", sep = ""), plot = barplot_gc_capped, width = 8, height = 6, units = "in", dpi = 300)
# }
```

# Create a heatmap over all correlations and save it
# Not necessary as we have the pheatmap below
```{r}
# heatmap_plot <- ggplot(data = df_adjusted, aes(x = p2_id, y = p1_id, fill = rg)) +
#   geom_tile() +
#   scale_fill_gradient(low = "firebrick4", high = "royalblue4") +
#   labs(x = "", y = "", title = "Genetic Correlation Heatmap (LDSC)") +
#   theme(axis.text.x = element_blank(),  # Remove x-axis labels from the bottom
#         axis.text.x.top = element_text(angle = 45, hjust = 1),  # Add x-axis labels to the top
#         axis.text.y = element_text(angle = 45, hjust = 1),   
#         plot.title = element_text(hjust = 0.5))
# heatmap_plot
# # Save the heatmap plot
# ggsave(file = paste(folder_heatmaps, "/heatmap_ggplot_ldsc.png", sep = ""), plot = heatmap_plot, width = 8, height = 6, units = "in", dpi = 300)
```

#Pheatmap
```{r}
#install.packages("pheatmap")
library(pheatmap)
my_palette <- colorRampPalette(c("firebrick4", "white", "royalblue4"))(100)

# Create pheatmap with corrected correlation values (>1 values = 1, <-1 values = -1)

# Without hclust 
pheatmap_plot_withoutHclust <- pheatmap(matrix,
                          cluster_rows = FALSE,  
                          cluster_cols = FALSE, 
                          annotation_col = NULL,  # Use column names as annotations at the top
                          border_col = NA,
                          annotation_row = NULL, 
                          fontsize = 7.5,          # Set fontsize for labels
                          main = "Genetic Correlation Heatmap - corrected gc values (LDSC)", 
                          angle_col = 90,       
                          angle_row = 0,        
                          fontsize_row = 7.5,      # Set fontsize for row labels
                          fontsize_col = 7.5,      # Set fontsize for column labels
                          cellwidth = 7,        # Set cell width
                          cellheight = 7,       # Set cell height
                          col = my_palette       # Color scheme
)
ggsave(paste(folder_heatmaps, "/pheatmap_plot_withoutHclust_ldsc.png", sep=""), plot = pheatmap_plot_withoutHclust, width = 7, height = 7, units = "in", dpi = 300)
# With hclust 
pheatmap_plot_hclust <- pheatmap(matrix,
                          cluster_rows = FALSE,  
                          cluster_cols = TRUE, 
                          annotation_col = NULL,  # Use column names as annotations at the top
                          border_col = NA,
                          annotation_row = NULL, 
                          fontsize = 7.5,          # Set fontsize for labels
                          main = "Genetic Correlation Heatmap - corrected gc values and hclust (LDSC)", 
                          angle_col = 90,       
                          angle_row = 0,        
                          fontsize_row = 7.5,      # Set fontsize for row labels
                          fontsize_col = 7.5,      # Set fontsize for column labels
                          cellwidth = 7,        # Set cell width
                          cellheight = 7,       # Set cell height
                          col = my_palette       # Color scheme
)
ggsave(paste(folder_heatmaps, "/pheatmap_plot_hclust_ldsc.png", sep="") , plot = pheatmap_plot_hclust, width = 7, height = 7, units = "in", dpi = 300)

# Create pheatmap without corrected correlation values (>1 and <-1 values are not corrected)

# Without hclust 
pheatmap_plot_woCorrection_withoutHclust <- pheatmap(matrix_woCorrection,
                          cluster_rows = FALSE,  
                          cluster_cols = FALSE, 
                          annotation_col = NULL,  # Use column names as annotations at the top
                          border_col = NA,
                          annotation_row = NULL, 
                          fontsize = 8,          # Set fontsize for labels
                          main = "Genetic Correlation Heatmap - uncorrected gc values (LDSC)", 
                          angle_col = 90,       
                          angle_row = 0,        
                          fontsize_row = 6,      # Set fontsize for row labels
                          fontsize_col = 6,      # Set fontsize for column labels
                          cellwidth = 7,        # Set cell width
                          cellheight = 7,       # Set cell height
                          col = my_palette       # Color scheme
)
ggsave(paste(folder_heatmaps, "/pheatmap_plot_woCorrection_withoutHclust_ldsc.png", sep=""), plot = pheatmap_plot_woCorrection_withoutHclust, width = 7, height = 7, units = "in", dpi = 300)

# With hclust 
pheatmap_plot_woCorrection_hclust <- pheatmap(matrix_woCorrection,
                          cluster_rows = FALSE,  
                          cluster_cols = TRUE, 
                          annotation_col = NULL,  # Use column names as annotations at the top
                          border_col = NA,
                          annotation_row = NULL, 
                          fontsize = 8,          # Set fontsize for labels
                          main = "Genetic Correlation Heatmap - uncorrected gc values and hclust (LDSC)", 
                          angle_col = 90,       
                          angle_row = 0,        
                          fontsize_row = 6,      # Set fontsize for row labels
                          fontsize_col = 6,      # Set fontsize for column labels
                          cellwidth = 7,        # Set cell width
                          cellheight = 7,       # Set cell height
                          col = my_palette       # Color scheme
)
ggsave(paste(folder_heatmaps, "/pheatmap_plot_woCorrection_hclust_ldsc.png", sep=""), plot = pheatmap_plot_woCorrection_hclust, width = 7, height = 7, units = "in", dpi = 300)
```



Check diagonal values of the uncorrected gc values 
```{r, comment=NA}
# Check diagonal values of the uncorrected gc values -> they should be 1 as there is full correlation
matrix_woCorrection <- as.matrix(matrix_woCorrection)
diagonal_values <- diag(as.matrix(matrix_woCorrection))

# Initialize counters
correlation_diag_yes <- 0
correlation_diag_no <- 0

# Define tolerance levels
tolerance_lower <- 0.995
tolerance_upper <- 1.005

# Iterate over each value in the diagonal correlation values 
for (value in diagonal_values) {
  # Check if the value falls within the tolerance range
  if (value < tolerance_upper && value > tolerance_lower) {
    correlation_diag_yes <- correlation_diag_yes + 1
  } else {
    correlation_diag_no <- correlation_diag_no + 1 
  }
}

# Print the counts
cat(paste("Within tolerance range:", correlation_diag_yes))
cat(paste("Outside tolerance range:", correlation_diag_no))
```


Determine a threshold in order to create a more dense heatmap 
-> Check all columns of the matrix with adjustments and check how many values are 0
-> Choose median as threshold instead of mean as median is not influenced by outliers 
```{r}
sum_of_notzeros <- colSums(matrix != 0)
median_of_notzeros <- median(sum_of_notzeros)
median_matrix <- matrix[sum_of_notzeros > median_of_notzeros, sum_of_notzeros > median_of_notzeros]

pheatmap_median <- pheatmap(median_matrix,
                          cluster_rows = FALSE,  
                          cluster_cols = FALSE, 
                          annotation_col = NULL,  # Use column names as annotations at the top
                          border_col = NA,
                          annotation_row = NULL, 
                          fontsize = 7.5,          # Set fontsize for labels
                          main = "Genetic Correlation Heatmap \n median as threshold (LDSC)", 
                          angle_col = 90,       
                          angle_row = 0,        
                          fontsize_row = 7.5,      # Set fontsize for row labels
                          fontsize_col = 7.5,      # Set fontsize for column labels
                          cellwidth = 10,        # Set cell width
                          cellheight = 10,       # Set cell height
                          col = my_palette       # Color scheme
)
ggsave(paste(folder_heatmaps, "/pheatmap_median.png", sep=""), plot = pheatmap_median, width = 4, height = 4, units = "in", dpi = 300)

pheatmap_median_hclust <- pheatmap(median_matrix,
                          cluster_rows = FALSE,  
                          cluster_cols = TRUE, 
                          annotation_col = NULL,  # Use column names as annotations at the top
                          border_col = NA,
                          annotation_row = NULL, 
                          fontsize = 7.5,          # Set fontsize for labels
                          main = "Genetic Correlation Heatmap \n median as threshold and clustering (LDSC)", 
                          angle_col = 90,       
                          angle_row = 0,        
                          fontsize_row = 7.5,      # Set fontsize for row labels
                          fontsize_col = 7.5,      # Set fontsize for column labels
                          cellwidth = 8,        # Set cell width
                          cellheight = 8,       # Set cell height
                          col = my_palette       # Color scheme
)

ggsave(paste(folder_heatmaps, "/pheatmap_median_hclust.png", sep=""), plot = pheatmap_median_hclust, width = 4, height = 4, units = "in", dpi = 300)

```





