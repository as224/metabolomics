---
title: "plot_gc"
author: "AÃ¯sha Schuhegger"
date: "2/15/2024"
output: html_document
---

# This script is for plotting the genetic correlations as bar plots, heatmaps and pheatmaps. 
# Load libraries
```{r}
library(ggplot2)
library(reshape2)
```

# Read in the separate tsv files (output_ld_regression tsv files)
```{r}
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
folder_path <- "../output_ld_regression"
folder_path_plots <- "../plots_ldsc/"
folder_barplots <- "../plots/barplots"
folder_heatmaps <- "../plots/heatmaps"

# Check if the folder exists
if (!dir.exists(folder_path_plots)) {
  # If the folder does not exist, create it
  dir.create(folder_path_plots, recursive = TRUE)
  print(paste("Folder", folder_path_plots, "created."))
} else {
  print(paste("Folder", folder_path_plots, "already exists."))
}

if (!dir.exists(folder_barplots)) {
  # If the folder does not exist, create it
  dir.create(folder_barplots, recursive = TRUE)
  print(paste("Folder", folder_barplots, "created."))
} else {
  print(paste("Folder", folder_barplots, "already exists."))
}

if (!dir.exists(folder_heatmaps)) {
  # If the folder does not exist, create it
  dir.create(folder_heatmaps, recursive = TRUE)
  print(paste("Folder", folder_heatmaps, "created."))
} else {
  print(paste("Folder", folder_heatmaps, "already exists."))
}


files <- list.files(path = folder_path, pattern = "^output_.*\\.tsv$", full.names = TRUE)
#files_capped <- list.files(path = folder_path, pattern = "^capped_.*\\.tsv$", full.names = TRUE) #not necessary 

df <- read.table(paste(folder_path,"/complete_df.tsv", sep=""), header=TRUE)
df_adjusted <- read.table(paste(folder_path,"/complete_df_adjusted.tsv", sep=""), header=TRUE)

matrix <- read.table(paste(folder_path, "/matrix_df.tsv", sep=""), header=TRUE)
matrix_woCorrection <- read.table(paste(folder_path, "/matrix_df_woCorrection.tsv", sep=""), header=TRUE)
matrix_correction_sign <- read.table(paste(folder_path, "/matrix_df_correction_sign.tsv", sep=""), header=TRUE)

```

#Pheatmap
```{r}
#install.packages("pheatmap")
library(pheatmap)
my_palette <- colorRampPalette(c("firebrick4", "white", "royalblue4"))(100)

# Create pheatmap with corrected correlation values (>1 values = 1, <-1 values = -1)

# Without hclust 
pheatmap_plot_withoutHclust <- pheatmap(matrix,
                          cluster_rows = FALSE,  
                          cluster_cols = FALSE, 
                          annotation_col = NULL,  # Use column names as annotations at the top
                          border_col = NA,
                          annotation_row = NULL, 
                          fontsize = 13,          # Set fontsize for labels
                          main = "Genetic Correlation Heatmap - corrected gc values (LDSC)", 
                          angle_col = 90,       
                          angle_row = 0,        
                          fontsize_row = 9,      # Set fontsize for row labels
                          fontsize_col = 9,      # Set fontsize for column labels
                          cellwidth = 11,        # Set cell width
                          cellheight = 11,       # Set cell height
                          col = my_palette       # Color scheme
)
ggsave(paste(folder_heatmaps, "/pheatmap_plot_withoutHclust_ldsc.png", sep=""), plot = pheatmap_plot_withoutHclust, width = 13.5, height = 14, units = "in", dpi = 300)
# With hclust 
pheatmap_plot_hclust <- pheatmap(matrix,
                          cluster_rows = FALSE,  
                          cluster_cols = TRUE, 
                          annotation_col = NULL,  # Use column names as annotations at the top
                          border_col = NA,
                          annotation_row = NULL, 
                          fontsize = 13,          # Set fontsize for labels
                          main = "Genetic Correlation Heatmap - corrected gc values and hclust (LDSC)", 
                          angle_col = 90,       
                          angle_row = 0,        
                          fontsize_row = 9,      # Set fontsize for row labels
                          fontsize_col = 9,      # Set fontsize for column labels
                          cellwidth = 11,        # Set cell width
                          cellheight = 11,       # Set cell height
                          col = my_palette       # Color scheme
)
ggsave(paste(folder_heatmaps, "/pheatmap_plot_hclust_ldsc.png", sep="") , plot = pheatmap_plot_hclust, width = 13.5, height = 14, units = "in", dpi = 300)

# Create pheatmap without corrected correlation values (>1 and <-1 values are not corrected)

# Without hclust 
pheatmap_plot_woCorrection_withoutHclust <- pheatmap(matrix_woCorrection,
                          cluster_rows = FALSE,  
                          cluster_cols = FALSE, 
                          annotation_col = NULL,  # Use column names as annotations at the top
                          border_col = NA,
                          annotation_row = NULL, 
                          fontsize = 13,          # Set fontsize for labels
                          main = "Genetic Correlation Heatmap - uncorrected gc values (LDSC)", 
                          angle_col = 90,       
                          angle_row = 0,        
                          fontsize_row = 9,      # Set fontsize for row labels
                          fontsize_col = 9,      # Set fontsize for column labels
                          cellwidth = 11,        # Set cell width
                          cellheight = 11,       # Set cell height
                          col = my_palette       # Color scheme
)
ggsave(paste(folder_heatmaps, "/pheatmap_plot_woCorrection_withoutHclust_ldsc.png", sep=""), plot = pheatmap_plot_woCorrection_withoutHclust, width = 13.5, height = 14, units = "in", dpi = 300)

# With hclust 
pheatmap_plot_woCorrection_hclust <- pheatmap(matrix_woCorrection,
                          cluster_rows = FALSE,  
                          cluster_cols = TRUE, 
                          annotation_col = NULL,  # Use column names as annotations at the top
                          border_col = NA,
                          annotation_row = NULL, 
                          fontsize = 13,          # Set fontsize for labels
                          main = "Genetic Correlation Heatmap - uncorrected gc values and hclust (LDSC)", 
                          angle_col = 90,       
                          angle_row = 0,        
                          fontsize_row = 9,      # Set fontsize for row labels
                          fontsize_col = 9,      # Set fontsize for column labels
                          cellwidth = 11,        # Set cell width
                          cellheight = 11,       # Set cell height
                          col = my_palette       # Color scheme
)
ggsave(paste(folder_heatmaps, "/pheatmap_plot_woCorrection_hclust_ldsc.png", sep=""), plot = pheatmap_plot_woCorrection_hclust, width = 13.5, height = 14, units = "in", dpi = 300)


pheatmap_plot_corr_sign <- pheatmap(matrix_correction_sign,
                          cluster_rows = FALSE,  
                          cluster_cols = FALSE, 
                          annotation_col = NULL,  # Use column names as annotations at the top
                          border_col = NA,
                          annotation_row = NULL, 
                          fontsize = 13,          # Set fontsize for labels
                          main = "Genetic Correlation Heatmap - corrected gc values and p<0.05 (LDSC)", 
                          angle_col = 90,       
                          angle_row = 0,        
                          fontsize_row = 9,      # Set fontsize for row labels
                          fontsize_col = 9,      # Set fontsize for column labels
                          cellwidth = 11,        # Set cell width
                          cellheight = 11,       # Set cell height
                          col = my_palette       # Color scheme
)
ggsave(paste(folder_heatmaps, "/pheatmap_corr_sign_ldsc.png", sep=""), plot = pheatmap_plot_corr_sign, width = 13.5, height = 14, units = "in", dpi = 300)

# pheatmap_plot_corr_sign_hclust <- pheatmap(matrix_correction_sign,
#                           cluster_rows = FALSE,  
#                           cluster_cols = TRUE, 
#                           annotation_col = NULL,  # Use column names as annotations at the top
#                           border_col = NA,
#                           annotation_row = NULL, 
#                           fontsize = 13,          # Set fontsize for labels
#                           main = "Genetic Correlation Heatmap - corrected gc values and p<0.05 and hclust (LDSC)", 
#                           angle_col = 90,       
#                           angle_row = 0,        
#                           fontsize_row = 9,      # Set fontsize for row labels
#                           fontsize_col = 9,      # Set fontsize for column labels
#                           cellwidth = 11,        # Set cell width
#                           cellheight = 11,       # Set cell height
#                           col = my_palette       # Color scheme
# )
# ggsave(paste(folder_heatmaps, "/pheatmap_corr_sign_hclust_ldsc.png", sep=""), plot = pheatmap_plot_corr_sign_hclust, width = 13.5, height = 14, units = "in", dpi = 300)
```



Check diagonal values of the uncorrected gc values 
```{r, comment=NA}
# Check diagonal values of the uncorrected gc values -> they should be 1 as there is full correlation
matrix_woCorrection <- as.matrix(matrix_woCorrection)
diagonal_values <- diag(as.matrix(matrix_woCorrection))

# Initialize counters
correlation_diag_yes <- 0
correlation_diag_no <- 0

# Define tolerance levels
tolerance_lower <- 0.995
tolerance_upper <- 1.005

# Iterate over each value in the diagonal correlation values 
for (value in diagonal_values) {
  # Check if the value falls within the tolerance range
  if (value < tolerance_upper && value > tolerance_lower) {
    correlation_diag_yes <- correlation_diag_yes + 1
  } else {
    correlation_diag_no <- correlation_diag_no + 1 
  }
}

# Print the counts
cat(paste("Within tolerance range:", correlation_diag_yes))
cat(paste("Outside tolerance range:", correlation_diag_no))
```


Determine a threshold in order to create a more dense heatmap 
-> Check all columns of the matrix with adjustments and check how many values are 0
-> Choose median as threshold instead of mean as median is not influenced by outliers 
```{r}
sum_of_notzeros <- colSums(matrix != 0)
median_of_notzeros <- median(sum_of_notzeros)
median_matrix <- matrix[sum_of_notzeros > median_of_notzeros, sum_of_notzeros > median_of_notzeros]

# only those where the diag value = 1or in tolerance range 
#todo
diag_vals <- diag(as.matrix(median_matrix))
filtered_median_matrix <- median_matrix[diag_vals >= 0.995 & diag_vals <= 1.005, diag_vals >= 0.995 & diag_vals <= 1.005]

pheatmap_median <- pheatmap(filtered_median_matrix,
                          cluster_rows = FALSE,  
                          cluster_cols = FALSE, 
                          annotation_col = NULL,  # Use column names as annotations at the top
                          border_col = NA,
                          annotation_row = NULL, 
                          fontsize = 10,          # Set fontsize for labels
                          main = "Genetic Correlation Heatmap \n median as threshold (LDSC)", 
                          angle_col = 90,       
                          angle_row = 0,        
                          fontsize_row = 6.5,      # Set fontsize for row labels
                          fontsize_col = 6.5,      # Set fontsize for column labels
                          cellwidth = 10,        # Set cell width
                          cellheight = 10,       # Set cell height
                          col = my_palette       # Color scheme
)
ggsave(paste(folder_heatmaps, "/pheatmap_median.png", sep=""), plot = pheatmap_median, width = 7.5, height = 7.5, units = "in", dpi = 300)

pheatmap_median_hclust <- pheatmap(filtered_median_matrix,
                          cluster_rows = FALSE,  
                          cluster_cols = TRUE, 
                          annotation_col = NULL,  # Use column names as annotations at the top
                          border_col = NA,
                          annotation_row = NULL, 
                          fontsize = 10,          # Set fontsize for labels
                          main = "Genetic Correlation Heatmap \n median as threshold and clustering (LDSC)", 
                          angle_col = 90,       
                          angle_row = 0,        
                          fontsize_row = 6.5,      # Set fontsize for row labels
                          fontsize_col = 6.5,      # Set fontsize for column labels
                          cellwidth = 8,        # Set cell width
                          cellheight = 8,       # Set cell height
                          col = my_palette       # Color scheme
)

ggsave(paste(folder_heatmaps, "/pheatmap_median_hclust.png", sep=""), plot = pheatmap_median_hclust, width = 6, height = 7.5, units = "in", dpi = 300)

```

```{r}
sum_of_notzeros_sign <- colSums(matrix_correction_sign != 0)
median_of_notzeros_sign <- median(sum_of_notzeros_sign)
median_matrix_sign <- matrix_correction_sign[sum_of_notzeros_sign > median_of_notzeros_sign, sum_of_notzeros_sign > median_of_notzeros_sign]

# only those where the diag value = 1or in tolerance range 
#todo
diag_vals_sign <- diag(as.matrix(median_matrix_sign))
filtered_median_matrix_sign <- median_matrix_sign[diag_vals_sign >= 0.995 & diag_vals_sign <= 1.005, diag_vals_sign >= 0.995 & diag_vals_sign <= 1.005]

pheatmap_median_sign <- pheatmap(filtered_median_matrix_sign,
                          cluster_rows = FALSE,  
                          cluster_cols = FALSE, 
                          annotation_col = NULL,  # Use column names as annotations at the top
                          border_col = NA,
                          annotation_row = NULL, 
                          fontsize = 10,          # Set fontsize for labels
                          main = "Genetic Correlation Heatmap \n median as threshold (p<0.05) (LDSC)", 
                          angle_col = 90,       
                          angle_row = 0,        
                          fontsize_row = 6.5,      # Set fontsize for row labels
                          fontsize_col = 6.5,      # Set fontsize for column labels
                          cellwidth = 10,        # Set cell width
                          cellheight = 10,       # Set cell height
                          col = my_palette       # Color scheme
)
ggsave(paste(folder_heatmaps, "/pheatmap_median_sign.png", sep=""), plot = pheatmap_median_sign, width = 7.5, height = 7.5, units = "in", dpi = 300)

pheatmap_median_hclust_sign <- pheatmap(filtered_median_matrix_sign,
                          cluster_rows = FALSE,  
                          cluster_cols = TRUE, 
                          annotation_col = NULL,  # Use column names as annotations at the top
                          border_col = NA,
                          annotation_row = NULL, 
                          fontsize = 10,          # Set fontsize for labels
                          main = "Genetic Correlation Heatmap \n median as threshold and clustering (p<0.05) (LDSC)", 
                          angle_col = 90,       
                          angle_row = 0,        
                          fontsize_row = 6.5,      # Set fontsize for row labels
                          fontsize_col = 6.5,      # Set fontsize for column labels
                          cellwidth = 8,        # Set cell width
                          cellheight = 8,       # Set cell height
                          col = my_palette       # Color scheme
)

ggsave(paste(folder_heatmaps, "/pheatmap_median_hclust_sign.png", sep=""), plot = pheatmap_median_hclust_sign, width = 6, height = 7.5, units = "in", dpi = 300)

```





